<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Produtividade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Existing productivity colors for text/backgrounds */
        .productivity-green { background-color: #d1fae5; color: #065f46; }
        .productivity-yellow { background-color: #fef3c7; color: #92400e; }
        .productivity-red { background-color: #fee2e2; color: #991b1b; }

        /* New row colors for productivity */
        .productivity-green-row { background-color: #f0fdf4; /* green-50 light */ }
        .productivity-yellow-row { background-color: #fffbeb; /* yellow-50 light */ }
        .productivity-red-row { background-color: #fef2f2; /* red-50 light */ }

        /* Ensure text is readable on light backgrounds */
        .productivity-green-row td,
        .productivity-yellow-row td,
        .productivity-red-row td,
        .productivity-green-row td input,
        .productivity-yellow-row td input,
        .productivity-red-row td input,
        .productivity-green-row td select,
        .productivity-yellow-row td select,
        .productivity-red-row td select,
        .productivity-green-row td textarea,
        .productivity-yellow-row td textarea,
        .productivity-red-row td textarea {
            color: #374151; /* gray-700 */
        }
        /* Apply productivity row color to modal content wrapper */
        #modal-content-wrapper.productivity-green-card { background-color: #d1fae5; } /* green-200 */
        #modal-content-wrapper.productivity-yellow-card { background-color: #fef3c7; } /* yellow-200 */
        #modal-content-wrapper.productivity-red-card { background-color: #fee2e2; } /* red-200 */


        .alarm-visual {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Adjusted nav button styles for better visibility on hover */
        .nav-btn-active {
            background-color: #2563eb;
            color: white;
        }
        .nav-btn-inactive {
            background-color: #e5e7eb;
            color: #374151;
        }
        .nav-btn-inactive:hover {
            background-color: #d1d5db; /* gray-300 */
            color: #1f2937; /* Darker text for better contrast */
        }

        /* Style for the copyable code block */
        .code-block {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563; /* gray-600 */
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .copy-btn:hover {
            background-color: #6b7280; /* gray-500 */
        }

        /* Sidebar styles */
        .sidebar {
            width: 280px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }
        
        /* Fixed action bar */
        .fixed-action-bar {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40; /* Below modals, above main content */
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* pill shape */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            gap: 1rem;
        }

        /* Current time display */
        .current-time-display {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            z-index: 40;
        }

        /* General message box */
        #message-box {
            position: fixed; /* Changed to fixed */
            top: 1rem; /* Position at top */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for centering */
            width: fit-content; /* Adjust width to content */
            max-width: 90%; /* Ensure it doesn't overflow on small screens */
            background-color: #e2e8f0; /* bg-blue-100 */
            border: 1px solid #90cdf4; /* border-blue-400 */
            color: #2b6cb0; /* text-blue-700 */
            padding: 0.75rem 1rem;
            padding-right: 2.5rem; /* Added padding-right to make space for the close button */
            border-radius: 0.5rem;
            z-index: 1000; /* Higher z-index to appear over everything */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        #message-box.success {
            background-color: #d1fae5; /* green-100 */
            border-color: #38a169; /* green-600 */
            color: #2f855a; /* green-800 */
        }
        #message-box.warning {
            background-color: #fefcbf; /* yellow-100 */
            border-color: #d69e2e; /* yellow-600 */
            color: #b7791f; /* yellow-800 */
        }
        #message-box.error {
            background-color: #fee2e2; /* red-100 */
            border-color: #e53e3e; /* red-600 */
            color: #c53030; /* red-800 */
        }
        #message-box .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: inherit;
        }

        /* Drag and Drop styles */
        .dragging {
            opacity: 0.5;
            background-color: #f0f4f8; /* Light gray to indicate dragging */
        }
        .drag-over {
            border-top: 2px solid #3b82f6; /* Blue border to indicate drop target */
        }

        /* Highlight for overdue/pending activities */
        .activity-pending {
            background-color: #fbd38d !important; /* orange-300 */
            opacity: 0.8;
        }
        
        /* Highlight for active activity */
        .activity-active-row {
            outline: 2px solid #3b82f6; /* Blue outline */
            outline-offset: -2px; /* Pull outline inside border */
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); /* Blue glow */
        }

        /* Highlight for recorded time exceeding planned time */
        .time-exceeded {
            color: #ef4444; /* red-500 */
            font-weight: bold;
        }

        /* Smart Summary Modal Content Styling */
        #smart-summary-content {
            max-height: 70vh; /* Set a max height for scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 1rem; /* Add some padding around the content */
        }

        /* For the modal description to prevent overflow */
        #modal-activity-description {
            word-break: break-word;
            white-space: normal; /* Ensure normal wrapping for long text */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex">

    <!-- Sidebar / Barra Lateral -->
    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 bg-gray-800 text-white p-6 shadow-xl flex flex-col justify-between overflow-y-auto">
        <div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Menu</h2>
                <button id="close-sidebar-btn" class="text-gray-400 hover:text-white focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <ul class="space-y-4">
                <li><button id="sidebar-show-plan-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none nav-btn-active">Plano de Produtividade</button></li>
                <li><button id="sidebar-show-tips-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none nav-btn-inactive">Dicas e Incentivos</button></li>
                <li><button id="sidebar-show-stats-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none nav-btn-inactive">Estatísticas</button></li>
                <li><button id="sidebar-show-quick-add-manage-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none nav-btn-inactive">Gerenciar Atividades Rápidas</button></li>
            </ul>

            <div class="mt-8 space-y-4">
                <h3 class="text-lg font-semibold mb-2">Gerenciar Templates</h3>
                <div>
                    <label for="template-name-input" class="block text-sm font-medium text-gray-300">Nome do novo template:</label>
                    <div class="flex mt-1">
                        <input type="text" id="template-name-input" class="bg-gray-700 text-white text-sm rounded-l-md block w-full p-2.5 border border-gray-600 focus:ring-blue-500 focus:border-blue-500" placeholder="Meu Template Matinal">
                        <button id="save-template-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 focus:outline-none">Salvar</button>
                    </div>
                </div>
                <div>
                    <label for="load-template-select" class="block text-sm font-medium text-gray-300">Carregar Template:</label>
                    <div class="flex mt-1">
                        <select id="load-template-select" class="bg-gray-700 text-white text-sm rounded-l-md block w-full p-2.5 border border-gray-600 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione um template</option>
                        </select>
                        <button id="load-template-btn" class="bg-green-600 text-white px-4 py-2 rounded-r-md hover:bg-green-700 focus:outline-none">Carregar</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 space-y-4">
                <h3 class="text-lg font-semibold mb-2">Opções de Plano</h3>
                <button id="sidebar-export-csv-btn" class="w-full text-left px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white focus:outline-none">Exportar para CSV</button>
                <button id="sidebar-import-csv-btn" class="w-full text-left px-4 py-2 rounded-md bg-teal-600 hover:bg-teal-700 text-white focus:outline-none">Importar de CSV</button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                <button id="sidebar-save-pdf-btn" class="w-full text-left px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white focus:outline-none">Salvar como PDF</button>
                <button id="generate-summary-btn" class="w-full text-left px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white focus:outline-none">Gerar Resumo Inteligente ✨</button>
                <button id="save-daily-summary-btn" class="w-full text-left px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white focus:outline-none">Salvar Resumo Diário</button>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"></div>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-1">
        <!-- Barra de Navegação -->
        <nav class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex justify-between items-center">
                <button id="open-sidebar-btn" class="text-gray-600 hover:text-gray-900 focus:outline-none mr-4">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-900 flex-grow">Meu Plano de Produtividade</h1>
            </div>
            <p id="current-date" class="text-sm text-gray-500 mt-2"></p>
        </nav>

        <!-- General Message Box -->
        <div id="message-box" class="hidden">
            <p id="message-text"></p>
            <button class="close-btn" onclick="document.getElementById('message-box').classList.add('hidden')">X</button>
        </div>

        <!-- Seção Principal: Plano de Produtividade -->
        <main id="plan-section">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-2">💡 Dica do Dia</h3>
                <p id="daily-tip" class="text-gray-600 italic">"A chave não é priorizar o que está na sua agenda, mas agendar suas prioridades." - Stephen Covey</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table id="productivity-table" class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-2 py-3"><input type="checkbox" id="select-all-activities" class="rounded text-blue-600 focus:ring-blue-500"></th>
                                <th scope="col" class="px-2 py-3"></th> <!-- Drag handle -->
                                <th scope="col" class="px-4 py-3">Horário</th>
                                <th scope="col" class="px-6 py-3">Atividade Detalhada</th>
                                <th scope="col" class="px-4 py-3">Duração (min/HH:MM)</th>
                                <th scope="col" class="px-4 py-3">Registrado</th>
                                <th scope="col" class="px-4 py-3">Produtividade</th>
                                <th scope="col" class="px-4 py-3">Alavancador</th>
                                <th scope="col" class="px-4 py-3 text-center">
                                    <!-- Botão "Adicionar Atividade" movido para o cabeçalho da tabela -->
                                    <button id="add-activity-column-btn" class="p-1 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Linhas de atividade serão inseridas aqui via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção Adicionar Rapidamente (Predefinidas e Personalizadas) -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Adicionar Rapidamente</h3>
                <div id="quick-add-buttons" class="flex flex-wrap gap-3">
                    <!-- Botões de atividade rápida (predefinidas e personalizadas) serão inseridos aqui via JS -->
                </div>
            </div>
        </main>

        <!-- Seção de Gerenciamento de Atividades Rápidas Personalizadas -->
        <section id="quick-add-manage-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Gerenciar Atividades Rápidas</h2>
                
                <div class="mt-6 border-t pt-4 border-gray-200">
                    <h4 class="text-md font-semibold mb-3">Adicionar Nova Atividade Rápida</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="new-custom-quick-add-description" placeholder="Descrição" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <input type="text" id="new-custom-quick-add-duration" placeholder="Duração (minutos ou HH:MM)" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <select id="new-custom-quick-add-productivity" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="">Produtividade</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <select id="new-custom-quick-add-lever" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="">Alavancador</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <button id="add-custom-quick-activity-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Adicionar Nova Atividade Rápida</button>
                </div>

                <h3 class="text-lg font-semibold mb-4 mt-6">Atividades Rápidas Atuais</h3>
                <div id="custom-quick-add-list" class="mt-4 space-y-2">
                    <!-- Lista de atividades rápidas (incluindo as predefinidas para exclusão) será renderizada aqui -->
                </div>
            </div>
        </section>

        <!-- Sumários -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Tempo por Produtividade (Hoje)</h3>
                <div id="productivity-summary" class="space-y-2">
                    <div class="flex justify-between items-center"><span class="font-medium productivity-green px-2 py-1 rounded">Verde</span><span id="summary-green" class="font-bold">00:00:00</span></div>
                    <div class="flex justify-between items-center"><span class="font-medium productivity-yellow px-2 py-1 rounded">Amarelo</span><span id="summary-yellow" class="font-bold">00:00:00</span></div>
                    <div class="flex justify-between items-center"><span class="font-medium productivity-red px-2 py-1 rounded">Vermelho</span><span id="summary-red" class="font-bold">00:00:00</span></div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Tempo por Alavancador (Hoje)</h3>
                <div id="lever-summary" class="space-y-2">
                    <!-- Sumários de alavancadores serão inseridos aqui via JS -->
                </div>
            </div>
        </div>
    </div>

        <!-- Seção Secundária: Dicas e Incentivos -->
        <aside id="tips-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">Gerenciar Dicas e Incentivos</h2>
                <div class="mb-4">
                    <label for="new-tip-input" class="block mb-2 text-sm font-medium text-gray-900">Adicionar nova dica:</label>
                    <div class="flex">
                        <input type="text" id="new-tip-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Digite sua dica ou frase motivacional...">
                        <button id="add-tip-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">Adicionar</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Minhas Dicas</h3>
                    <ul id="tips-list" class="list-disc list-inside space-y-2 text-gray-600">
                       <!-- Dicas serão inseridas aqui via JS -->
                    </ul>
                </div>
            </div>
             <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Como Funciona o Plano</h2>
                <div class="space-y-6 text-gray-700">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">O Conceito</h3>
                        <p>O objetivo deste plano é dar clareza sobre onde seu tempo está sendo investido. Ao categorizar cada atividade e registrar o tempo gasto, você obtém uma visão poderosa do seu dia, permitindo fazer ajustes para alinhar suas ações com seus objetivos de longo prazo.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Categorias de Produtividade</h3>
                        <p>As cores ajudam a avaliar rapidamente o impacto de cada atividade. A meta não é ter um dia 100% 'Verde', mas sim garantir que o tempo investido nas atividades 'Vermelhas' seja consciente e limitado.</p>
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                            <li><span class="font-bold text-green-700">Verde:</span> Atividades que geram alto retorno e te impulsionam para seus maiores objetivos. Ex: Estudar uma nova habilidade, trabalhar em um projeto prioritário, fazer um exercício intenso.</li>
                            <li><span class="font-bold text-yellow-800">Amarelo:</span> Atividades necessárias e neutras. Elas mantêm sua vida funcionando, mas não necessariamente a impulsionam. Ex: Cozinhar, limpar, responder e-mails de rotina, deslocamento.</li>
                            <li><span class="font-bold text-red-700">Vermelho:</span> Atividades de baixo ou nenhum valor, que muitas vezes servem como distração ou procrastinação. Ex: Rolar redes sociais sem propósito, assistir TV em excesso.</li>
                        </ul>
                    </div>
                     <div>
                        <h3 class="font-semibold text-lg mb-2">Alavancadores</h3>
                        <p>Os alavancadores mostram em quais áreas da sua vida você está investindo tempo. Isso ajuda a garantir um equilíbrio saudável. Acompanhe na aba "Estatísticas" para ver sua evolução ao longo do tempo.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Importação via CSV</h3>
                        <p>Para adicionar muitas atividades de uma vez, você pode importar um arquivo CSV. Crie um arquivo de texto (ex: no Bloco de Notas ou Google Sheets) e salve-o com a extensão `.csv`. Ele deve seguir o formato abaixo.</p>
                        <div class="mt-2 code-block">
<pre id="csv-example-code">Descricao,Duracao,Produtividade,Alavancador
Planejar o dia,15,Verde,Desenvolvimento Pessoal
Ler notícias,20,Amarelo,Outros
Desenvolver o relatório X,90,Verde,Desenvolvimento Profissional
Almoço,60,Amarelo,Saúde e Bem-Estar</pre>
                            <button id="copy-csv-btn" class="copy-btn">Copiar</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Seção de Estatísticas -->
        <aside id="stats-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Evolução do Tempo por Alavancador</h2>
                <canvas id="stats-chart"></canvas>
            </div>
        </aside>

        <!-- Modal de Alarme -->
        <div id="alarm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 text-center max-w-sm mx-auto alarm-visual">
                <h3 class="text-xl font-bold text-red-600 mb-4">Alarme!</h3>
                <p id="alarm-message" class="mb-6"></p>
                <button id="close-alarm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Entendido</button>
            </div>
        </div>

        <!-- Modal de Atividade Ativa -->
        <div id="active-activity-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-auto relative" id="modal-content-wrapper">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Atividade Atual</h3>
                <button id="close-active-activity-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div class="space-y-4 text-center">
                    <p class="text-3xl font-extrabold text-blue-600" id="modal-activity-description">Descrição da Atividade</p>
                    <p class="text-sm text-gray-500"><span id="modal-activity-productivity" class="font-medium"></span> / <span id="modal-activity-lever" class="font-medium"></span></p>
                    
                    <div class="mt-6">
                        <p class="text-xl font-semibold text-gray-700">Tempo Registrado:</p>
                        <p class="text-5xl font-mono text-gray-900 mb-2" id="modal-recorded-time-hhmmss">00:00:00</p>
                        <p class="text-lg text-gray-600" id="modal-recorded-time-friendly"></p>
                    </div>

                    <div class="text-sm text-gray-500 mt-2" id="modal-planned-time-info">
                        Tempo Planeado: <span id="modal-planned-time">00:00</span>
                    </div>

                    <div class="flex justify-center space-x-4 mt-6">
                        <button id="modal-pause-btn" class="p-3 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 focus:outline-none">
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <button id="modal-reset-btn" class="p-3 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none">
                            <!-- Ícone de zerar mais coerente (circular arrow) -->
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 005.707 5.707L4 7.414V4m0 0h5.712m2.41 13.707l-1.414 1.414A8.001 8.001 0 0018.293 4.293M20 20v-5h-.582"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="border-t border-gray-200 pt-6 mt-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Cronómetro Pomodoro</h4>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <p class="text-5xl font-mono text-gray-900 mb-2" id="pomodoro-timer">25:00</p>
                            <div class="flex justify-center space-x-4">
                                <button id="pomodoro-start-btn" class="p-3 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 focus:outline-none">
                                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                                <button id="pomodoro-pause-btn" class="p-3 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 focus:outline-none">
                                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                                <button id="pomodoro-reset-btn" class="p-3 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none">
                                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 005.707 5.707L4 7.414V4m0 0h5.712m2.41 13.707l-1.414 1.414A8.001 8.001 0 0018.293 4.293M20 20v-5h-.582"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Resumo Inteligente -->
        <div id="smart-summary-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-auto relative">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Resumo Inteligente do Dia ✨</h3>
                <button id="close-smart-summary-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div id="smart-summary-content" class="prose max-w-none text-gray-700">
                    <!-- Conteúdo gerado pela LLM será inserido aqui -->
                    <p class="text-center text-gray-500 italic">A gerar o seu resumo...</p>
                </div>
                <div id="smart-summary-loading" class="flex justify-center items-center mt-4 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    <p class="ml-3 text-gray-600">A processar...</p>
                </div>
                <button id="copy-summary-btn" class="mt-6 px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Copiar para Área de Transferência</button>
            </div>
        </div>

        <!-- Modal de Confirmação -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 text-center max-w-sm mx-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmação</h3>
                <p id="confirmation-message" class="mb-6">Tem certeza que deseja realizar esta ação?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-yes-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sim</button>
                    <button id="confirm-no-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Não</button>
                </div>
            </div>
        </div>

        <!-- Fixed Action Bar (Rodapé Central) -->
        <div id="fixed-action-bar" class="fixed-action-bar hidden">
            <button id="action-start-btn" class="p-3 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
            <button id="action-pause-btn" class="p-3 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
            <button id="action-delete-btn" class="p-3 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>

        <!-- Current Time Display (Rodapé Esquerdo) -->
        <div id="current-time-display" class="current-time-display">00:00:00</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referências de Elementos do DOM
            const tableBody = document.getElementById('table-body');
            const addActivityColumnBtn = document.getElementById('add-activity-column-btn'); // Novo botão
            const savePdfBtn = document.getElementById('sidebar-save-pdf-btn');
            const importCsvBtn = document.getElementById('sidebar-import-csv-btn');
            const exportCsvBtn = document.getElementById('sidebar-export-csv-btn');
            const csvFileInput = document.getElementById('csv-file-input');
            const copyCsvBtn = document.getElementById('copy-csv-btn');
            const saveDailySummaryBtn = document.getElementById('save-daily-summary-btn');
            
            const planSection = document.getElementById('plan-section');
            const tipsSection = document.getElementById('tips-section');
            const statsSection = document.getElementById('stats-section');
            const quickAddManageSection = document.getElementById('quick-add-manage-section'); // New section

            const showPlanBtn = document.getElementById('sidebar-show-plan-btn');
            const showTipsBtn = document.getElementById('sidebar-show-tips-btn');
            const showStatsBtn = document.getElementById('sidebar-show-stats-btn');
            const showQuickAddManageBtn = document.getElementById('sidebar-show-quick-add-manage-btn'); // New button

            const dailyTipEl = document.getElementById('daily-tip');
            const newTipInput = document.getElementById('new-tip-input');
            const addTipBtn = document.getElementById('add-tip-btn');
            const tipsListEl = document.getElementById('tips-list');
            
            const alarmModal = document.getElementById('alarm-modal');
            const closeAlarmBtn = document.getElementById('close-alarm-btn');

            const activeActivityModal = document.getElementById('active-activity-modal');
            const closeActiveActivityModalBtn = document.getElementById('close-active-activity-modal-btn');
            const modalActivityDescription = document.getElementById('modal-activity-description');
            const modalActivityProductivity = document.getElementById('modal-activity-productivity');
            const modalActivityLever = document.getElementById('modal-activity-lever');
            const modalRecordedTimeHHMMSS = document.getElementById('modal-recorded-time-hhmmss');
            const modalRecordedTimeFriendly = document.getElementById('modal-recorded-time-friendly');
            const modalPlannedTime = document.getElementById('modal-planned-time');
            const modalPauseBtn = document.getElementById('modal-pause-btn');
            const modalResetBtn = document.getElementById('modal-reset-btn');
            const modalContentWrapper = document.getElementById('modal-content-wrapper'); // New reference for modal content

            const pomodoroTimerEl = document.getElementById('pomodoro-timer');
            const pomodoroStartBtn = document.getElementById('pomodoro-start-btn');
            const pomodoroPauseBtn = document.getElementById('pomodoro-pause-btn');
            const pomodoroResetBtn = document.getElementById('pomodoro-reset-btn');

            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            let confirmationCallback = null;

            const currentDateEl = document.getElementById('current-date');
            const selectAllActivitiesCheckbox = document.getElementById('select-all-activities');

            const sidebar = document.getElementById('sidebar');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            const templateNameInput = document.getElementById('template-name-input');
            const saveTemplateBtn = document.getElementById('save-template-btn');
            const loadTemplateSelect = document.getElementById('load-template-select');
            const loadTemplateBtn = document.getElementById('load-template-btn');

            const quickAddButtonsContainer = document.getElementById('quick-add-buttons'); // Now in main section again
            const fixedActionBar = document.getElementById('fixed-action-bar');
            const actionStartBtn = document.getElementById('action-start-btn');
            const actionPauseBtn = document.getElementById('action-pause-btn');
            const actionDeleteBtn = document.getElementById('action-delete-btn');
            const currentTimeDisplay = document.getElementById('current-time-display');

            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // Custom Quick Add Elements (for management page)
            const newCustomQuickAddDescription = document.getElementById('new-custom-quick-add-description');
            const newCustomQuickAddDuration = document.getElementById('new-custom-quick-add-duration');
            const newCustomQuickAddProductivity = document.getElementById('new-custom-quick-add-productivity');
            const newCustomQuickAddLever = document.getElementById('new-custom-quick-add-lever');
            const addCustomQuickActivityBtn = document.getElementById('add-custom-quick-activity-btn');
            const customQuickAddList = document.getElementById('custom-quick-add-list');

            // LLM related elements
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const smartSummaryModal = document.getElementById('smart-summary-modal');
            const closeSmartSummaryModalBtn = document.getElementById('close-smart-summary-modal-btn');
            const smartSummaryContent = document.getElementById('smart-summary-content');
            const smartSummaryLoading = document.getElementById('smart-summary-loading');
            const copySummaryBtn = document.getElementById('copy-summary-btn');


            // Estado da Aplicação
            let activities = [];
            let tips = [];
            let templates = {};
            let historicalData = {};
            // Combined quick activities: pre-defined will also be managed here
            let allQuickActivities = []; 
            let activeTimerInterval = null;
            let activeTimerId = null;
            let chartInstance = null;
            let pomodoroInterval = null;
            let pomodoroTimeLeft = 25 * 60; // 25 minutes in seconds
            const DEFAULT_POMODORO_DURATION = 25 * 60;

            const productivityLevels = { green: 'Verde', yellow: 'Amarelo', red: 'Vermelho' };
            const levers = {
                health: 'Saúde e Bem-Estar',
                professional: 'Desenvolvimento Profissional',
                personal: 'Desenvolvimento Pessoal',
                relationships: 'Relacionamentos',
                finance: 'Finanças',
                other: 'Outros'
            };

            // Predefined Quick Activities (moved here to be consistent with allQuickActivities)
            const initialPredefinedQuickActivities = [
                { description: 'Almoço', duration: 60, productivity: 'yellow', lever: 'health' },
                { description: 'Pausa Curta', duration: 15, productivity: 'yellow', lever: 'health' },
                { description: 'Ver E-mails', duration: 30, productivity: 'yellow', lever: 'professional' },
                { description: 'Exercício', duration: 45, productivity: 'green', lever: 'health' },
                { description: 'Estudar Novo Tópico', duration: 60, productivity: 'green', lever: 'personal' },
            ];
            
            // --- Funções Principais ---

            const loadData = () => {
                const savedActivities = localStorage.getItem('productivityPlanActivities');
                const savedTips = localStorage.getItem('productivityPlanTips');
                const savedTemplates = localStorage.getItem('productivityPlanTemplates');
                const savedHistoricalData = localStorage.getItem('productivityPlanHistory');
                // Load all quick activities, default to initial predefined if none saved
                const savedAllQuickActivities = localStorage.getItem('productivityAllQuickActivities');


                activities = savedActivities ? JSON.parse(savedActivities) : [
                    { id: 1, startTime: '08:00', description: 'Trabalho Focado (Projeto A)', duration: 50, recordedTime: 0, productivity: 'green', lever: 'professional', alarmTriggered: false, selected: false },
                    { id: 2, startTime: '08:50', description: 'Pausa para café', duration: 10, recordedTime: 0, productivity: 'yellow', lever: 'health', alarmTriggered: false, selected: false },
                    { id: 3, startTime: '09:00', description: 'Reunião de equipe', duration: 60, recordedTime: 0, productivity: 'green', lever: 'professional', alarmTriggered: false, selected: false },
                ];
                tips = savedTips ? JSON.parse(savedTips) : [
                    "A disciplina é a ponte entre metas e realizações.",
                    "Feito é melhor que perfeito.",
                    "Comece onde você está. Use o que você tem. Faça o que você pode."
                ];
                templates = savedTemplates ? JSON.parse(savedTemplates) : {};
                historicalData = savedHistoricalData ? JSON.parse(savedHistoricalData) : {};
                allQuickActivities = savedAllQuickActivities ? JSON.parse(savedAllQuickActivities) : initialPredefinedQuickActivities;

                displayCurrentDate();
                displayDailyTip();
                renderTemplates();
                renderQuickAddButtons(); // Renders only buttons for main view
                renderCustomQuickAddList(); // Renders the list for management page
                populateQuickAddDropdowns(); // Populate the dropdowns
                render();
            };

            const saveData = () => {
                localStorage.setItem('productivityPlanActivities', JSON.stringify(activities));
                localStorage.setItem('productivityPlanTips', JSON.stringify(tips));
                localStorage.setItem('productivityPlanTemplates', JSON.stringify(templates));
                localStorage.setItem('productivityPlanHistory', JSON.stringify(historicalData));
                localStorage.setItem('productivityAllQuickActivities', JSON.stringify(allQuickActivities));
            };

            const render = () => {
                renderTable();
                updateSummaries();
                renderTips();
                updateFixedActionBarVisibility();
            };

            const renderTable = () => {
                tableBody.innerHTML = '';
                let lastEndTime = '00:00';
                const currentTime = new Date();
                const nowMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();

                activities.forEach((activity, index) => {
                    const row = document.createElement('tr');
                    let rowClasses = ['bg-white', 'border-b', 'hover:bg-gray-50'];
                    
                    // Add productivity-based row color class
                    if (activity.productivity === 'green') {
                        rowClasses.push('productivity-green-row');
                    } else if (activity.productivity === 'yellow') {
                        rowClasses.push('productivity-yellow-row');
                    } else if (activity.productivity === 'red') {
                        rowClasses.push('productivity-red-row');
                    }

                    // Add active row highlight
                    if (activeTimerId === activity.id) {
                        rowClasses.push('activity-active-row');
                    }

                    row.className = rowClasses.join(' ');

                    row.dataset.id = activity.id;
                    row.draggable = true; // Enable drag

                    const startTimeForRender = index === 0 ? activity.startTime : lastEndTime;
                    activity.startTime = startTimeForRender;
                    const endTime = calculateEndTime(startTimeForRender, activity.duration);
                    lastEndTime = endTime;

                    const plannedStartMinutes = timeToMinutes(activity.startTime);
                    const plannedEndMinutes = timeToMinutes(endTime);

                    const isPending = nowMinutes > plannedEndMinutes && activity.recordedTime === 0;
                    if (isPending) {
                        row.classList.add('activity-pending');
                    }

                    const timeExceededClass = activity.recordedTime > (activity.duration * 60) ? 'time-exceeded' : '';
                    const alarmClass = activity.alarmTriggered ? 'alarm-visual' : '';

                    row.innerHTML = `
                        <td class="px-2 py-2"><input type="checkbox" class="activity-checkbox rounded text-blue-600 focus:ring-blue-500" ${activity.selected ? 'checked' : ''}></td>
                        <td class="px-2 py-2 cursor-grab text-gray-400 drag-handle">⋮</td>
                        <td class="px-4 py-2 font-medium text-gray-900 whitespace-nowrap">
                            <input type="time" value="${activity.startTime}" class="w-24 bg-transparent focus:bg-white p-1 rounded border-transparent focus:border-gray-300" data-field="startTime">
                            - ${endTime}
                        </td>
                        <td class="px-6 py-2"><input type="text" value="${activity.description}" class="w-full bg-transparent focus:bg-white p-1 rounded border-transparent focus:border-gray-300" data-field="description"></td>
                        <td class="px-4 py-2">
                            <input type="text" value="${minutesToHHMM(activity.duration)}" placeholder="HH:MM ou minutos" class="w-28 bg-transparent focus:bg-white p-1 rounded border-transparent focus:border-gray-300" data-field="duration-flexible">
                            (${activity.duration} min)
                        </td>
                        <td class="px-4 py-2 font-mono ${alarmClass} ${timeExceededClass}">${formatTime(activity.recordedTime)}</td>
                        <td class="px-4 py-2"><select class="w-full bg-transparent p-1 rounded border-transparent focus:border-gray-300" data-field="productivity">${Object.entries(productivityLevels).map(([key, value]) => `<option value="${key}" ${activity.productivity === key ? 'selected' : ''}>${value}</option>`).join('')}</select></td>
                        <td class="px-4 py-2"><select class="w-full bg-transparent p-1 rounded border-transparent focus:border-gray-300" data-field="lever">${Object.entries(levers).map(([key, value]) => `<option value="${key}" ${activity.lever === key ? 'selected' : ''}>${value}</option>`).join('')}</select></td>
                        <td class="px-4 py-2 text-center">
                            <!-- Removed start-activity-btn and add-subtask-btn from here -->
                        </td>`;
                    tableBody.appendChild(row);
                });
                updateSelectAllCheckbox();
            };
            
            const renderTips = () => {
                tipsListEl.innerHTML = '';
                tips.forEach((tip, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `<span>${tip}</span><button data-index="${index}" class="remove-tip-btn text-red-500 hover:text-red-700 p-1">Remover</button>`;
                    tipsListEl.appendChild(li);
                });
            };
            
            const displayDailyTip = () => {
                const today = new Date().toDateString();
                const lastTipDate = localStorage.getItem('dailyTipDate');
                let tipIndex = localStorage.getItem('dailyTipIndex');

                if (today !== lastTipDate || tipIndex === null || tipIndex >= tips.length) {
                    tipIndex = Math.floor(Math.random() * tips.length);
                    localStorage.setItem('dailyTipDate', today);
                    localStorage.setItem('dailyTipIndex', tipIndex);
                }

                dailyTipEl.textContent = tips.length > 0 ? tips[tipIndex] : "Adicione suas próprias dicas!";
            };

            const displayCurrentDate = () => {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                currentDateEl.textContent = today.toLocaleDateString('pt-BR', options);
            };

            const updateSummaries = () => {
                const todayDate = new Date().toISOString().split('T')[0];
                const productivityTotals = { green: 0, yellow: 0, red: 0 };
                const leverTotals = Object.keys(levers).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});

                activities.forEach(activity => {
                    productivityTotals[activity.productivity] += activity.recordedTime;
                    leverTotals[activity.lever] += activity.recordedTime;
                });

                document.getElementById('summary-green').textContent = formatTime(productivityTotals.green);
                document.getElementById('summary-yellow').textContent = formatTime(productivityTotals.yellow);
                document.getElementById('summary-red').textContent = formatTime(productivityTotals.red);

                const leverSummaryEl = document.getElementById('lever-summary');
                leverSummaryEl.innerHTML = '';
                Object.entries(leverTotals).forEach(([key, totalTime]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center';
                    div.innerHTML = `<span>${levers[key]}</span><span class="font-bold">${formatTime(totalTime)}</span>`;
                    leverSummaryEl.appendChild(div);
                });

                if (!historicalData[todayDate]) {
                    historicalData[todayDate] = {};
                }
                // Ensure all levers are accounted for in historical data, even if 0
                Object.keys(levers).forEach(leverKey => {
                    historicalData[todayDate][leverKey] = leverTotals[leverKey];
                });

                saveData();
            };

            const showMessage = (type, message) => {
                messageBox.classList.remove('hidden', 'success', 'warning', 'error');
                messageBox.classList.add(type);
                messageText.textContent = message;
                // Optional: Auto-hide after some time
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            };

            const showConfirmation = (message, callback) => {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmationModal.classList.add('flex');
                confirmationCallback = callback;
            };

            // --- Funções de Manipulação de Eventos ---
            const handleAddActivity = () => {
                const lastActivity = activities[activities.length - 1];
                const newStartTime = lastActivity ? calculateEndTime(lastActivity.startTime, lastActivity.duration) : '09:00';
                activities.push({ id: Date.now(), startTime: newStartTime, description: 'Nova Atividade', duration: 30, recordedTime: 0, productivity: 'yellow', lever: 'other', alarmTriggered: false, selected: false });
                render();
                saveData();
                showMessage('success', 'Atividade adicionada!');
            };

            const handleTableClick = (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                const id = Number(row.dataset.id);
                const activityIndex = activities.findIndex(act => act.id === id);
                if (activityIndex === -1) return;

                if (e.target.classList.contains('activity-checkbox')) {
                    activities[activityIndex].selected = e.target.checked;
                    updateSelectAllCheckbox();
                    updateFixedActionBarVisibility();
                    saveData();
                } 
            };
            
            const handleTableChange = (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                const id = Number(row.dataset.id);
                const activityIndex = activities.findIndex(act => act.id === id);
                if (activityIndex === -1) return;

                const activity = activities[activityIndex];
                const field = e.target.dataset.field;
                let value = e.target.value;

                if (field === 'duration-flexible') {
                    // Handle flexible duration input (HH:MM or minutes)
                    let parsedDuration = 0;
                    if (value.includes(':')) {
                        const [hours, minutes] = value.split(':').map(Number);
                        parsedDuration = hours * 60 + minutes;
                    } else {
                        parsedDuration = parseInt(value, 10) || 0;
                    }
                    if (parsedDuration < 0) {
                        showMessage('warning', 'A duração não pode ser negativa.');
                        e.target.value = minutesToHHMM(activity.duration); // Revert to old value
                        return;
                    }
                    activity.duration = parsedDuration;
                    recalculateActivityTimes(activityIndex); // Recalculate times for all subsequent activities
                } else if (field === 'startTime') {
                    // Prevent start time from being before the previous activity's end time
                    if (activityIndex > 0) {
                        const prevActivity = activities[activityIndex - 1];
                        const prevEndTime = calculateEndTime(prevActivity.startTime, prevActivity.duration);
                        if (timeToMinutes(value) < timeToMinutes(prevEndTime)) {
                             showMessage('warning', 'A hora de início não pode ser anterior à hora de término da atividade anterior.');
                             e.target.value = activity.startTime; // Revert to old value
                             return;
                        }
                    }
                    activity.startTime = value;
                    recalculateActivityTimes(activityIndex); // Cascade from this point
                } else if (field === 'productivity') {
                    activity[field] = value;
                } else {
                    activity[field] = value;
                }
                saveData();
                render(); // Always re-render to ensure all changes (including cascade) are reflected
            };

            const recalculateActivityTimes = (startIndex) => {
                // Adjust startIndex to ensure the previous activity's end time is considered for the current one
                // If startIndex is 0, we start from 0. If > 0, we start from startIndex.
                // This loop ensures that each activity's start time is set correctly based on the previous activity's end time.
                for (let i = startIndex; i < activities.length; i++) {
                    const currentActivity = activities[i];
                    if (i > 0) { // Only adjust if there's a previous activity
                        const prevActivity = activities[i - 1];
                        currentActivity.startTime = calculateEndTime(prevActivity.startTime, prevActivity.duration);
                    } else if (i === 0 && activities.length > 0) {
                        // For the first activity, ensure its start time is what's set, don't change it.
                        // The initial value is handled in handleAddActivity.
                    }
                }
            };
            
            const handleCsvImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const csvContent = event.target.result;
                    
                    const reverseProductivity = Object.fromEntries(Object.entries(productivityLevels).map(([k, v]) => [v.trim(), k]));
                    const reverseLevers = Object.fromEntries(Object.entries(levers).map(([k, v]) => [v.trim(), k]));
                    
                    const lines = csvContent.split(/\r?\n/).slice(1); // Skip header

                    lines.forEach(line => {
                        if (line.trim() === '') return;
                        const [description, duration, productivityStr, leverStr] = line.split(',');

                        if (!description || !duration) return;

                        const newActivity = {
                            id: Date.now() + Math.random(),
                            startTime: '00:00', // Será recalculado no render()
                            description: description.trim(),
                            duration: parseInt(duration.trim(), 10) || 30,
                            recordedTime: 0,
                            productivity: reverseProductivity[productivityStr.trim()] || 'yellow',
                            lever: reverseLevers[leverStr.trim()] || 'other',
                            alarmTriggered: false,
                            selected: false
                        };
                        activities.push(newActivity);
                    });
                    recalculateActivityTimes(0); // Recalculate all times after import
                    render();
                    saveData();
                    showMessage('success', 'Plano importado com sucesso!');
                };

                reader.readAsText(file);
                e.target.value = null; // Reset input to allow re-importing the same file
            };

            const handleCsvExport = () => {
                const header = "Descricao,Duracao,Produtividade,Alavancador\n";
                const rows = activities.map(activity => 
                    `${activity.description},${activity.duration},${productivityLevels[activity.productivity]},${levers[activity.lever]}`
                ).join('\n');
                const csvContent = header + rows;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'plano-produtividade.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('success', 'Plano exportado para CSV!');
            };
            
             const handleCopyCsv = () => {
                const codeToCopy = document.getElementById('csv-example-code').innerText;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = codeToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                copyCsvBtn.textContent = 'Copiado!';
                setTimeout(() => {
                    copyCsvBtn.textContent = 'Copiar';
                }, 2000);
            };

            const handleSaveDailySummary = () => {
                updateSummaries(); // This function already updates historicalData and saves
                showMessage('success', 'Resumo diário salvo no histórico!');
            };

            // --- Lógica do Timer ---
            const startTimer = (id) => {
                if (activeTimerInterval) {
                    clearInterval(activeTimerInterval);
                    const prevActivity = activities.find(act => act.id === activeTimerId);
                    if (prevActivity) {
                        prevActivity.alarmTriggered = false; // Reset alarm for previously active activity
                    }
                }
                activeTimerId = id;
                const activity = activities.find(act => act.id === activeTimerId);
                if (activity) {
                    showMessage('success', `Atividade "${activity.description}" iniciada.`);
                }
                
                activeTimerInterval = setInterval(() => {
                    const currentActivity = activities.find(act => act.id === activeTimerId);
                    if (currentActivity) {
                        currentActivity.recordedTime++;
                        if (currentActivity.recordedTime >= currentActivity.duration * 60 && !currentActivity.alarmTriggered) {
                            currentActivity.alarmTriggered = true;
                            document.getElementById('alarm-message').textContent = `O tempo planejado para "${currentActivity.description}" terminou!`;
                            alarmModal.classList.remove('hidden');
                            alarmModal.classList.add('flex');
                            renderTable(); // Re-render to show alarm visual
                        }
                        // Update UI for main table
                        const timerCell = document.querySelector(`tr[data-id='${activeTimerId}'] td:nth-child(6)`);
                        if (timerCell) {
                            timerCell.textContent = formatTime(currentActivity.recordedTime);
                            if (currentActivity.recordedTime > (currentActivity.duration * 60)) {
                                timerCell.classList.add('time-exceeded');
                            } else {
                                timerCell.classList.remove('time-exceeded');
                            }
                        }

                        // Update UI for active activity modal
                        if (!activeActivityModal.classList.contains('hidden') && currentActivity.id === activeTimerId) {
                            modalRecordedTimeHHMMSS.textContent = formatTime(currentActivity.recordedTime);
                            modalRecordedTimeFriendly.textContent = formatSecondsToFriendly(currentActivity.recordedTime);
                        }
                        updateSummaries();
                        saveData();
                    } else {
                        // If active activity somehow disappears, stop the timer
                        pauseTimer();
                    }
                }, 1000);
                renderTable(); // Re-render to update active row highlight and button states
            };

            const pauseTimer = () => {
                if (activeTimerInterval) {
                    clearInterval(activeTimerInterval);
                    activeTimerInterval = null;
                    const activity = activities.find(act => act.id === activeTimerId);
                    if (activity) {
                        showMessage('warning', `Atividade "${activity.description}" pausada.`);
                    }
                    activeTimerId = null;
                    saveData();
                }
                renderTable(); // Re-render to update active row highlight and button states
            };

            const resetTimer = (id) => {
                const activity = activities.find(act => act.id === id);
                if (activity) {
                    activity.recordedTime = 0;
                    activity.alarmTriggered = false;
                    if (activeTimerId === id) pauseTimer();
                    render();
                    updateSummaries();
                    saveData();
                    showMessage('info', `Tempo da atividade "${activity.description}" zerado.`);
                }
            };
            
            // --- Pomodoro Timer Lógica ---
            const startPomodoro = () => {
                if (pomodoroInterval) clearInterval(pomodoroInterval);
                showMessage('info', 'Pomodoro iniciado!');
                pomodoroInterval = setInterval(() => {
                    pomodoroTimeLeft--;
                    pomodoroTimerEl.textContent = formatTime(pomodoroTimeLeft);
                    if (pomodoroTimeLeft <= 0) {
                        clearInterval(pomodoroInterval);
                        pomodoroInterval = null;
                        showMessage('success', 'Pomodoro concluído! Hora de uma pausa!');
                        // Consider playing a sound if allowed and feasible in sandbox
                        pomodoroTimerEl.textContent = "00:00";
                    }
                }, 1000);
            };

            const pausePomodoro = () => {
                if (pomodoroInterval) {
                    clearInterval(pomodoroInterval);
                    pomodoroInterval = null;
                    showMessage('warning', 'Pomodoro pausado.');
                }
            };

            const resetPomodoro = () => {
                if (pomodoroInterval) clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroTimeLeft = DEFAULT_POMODORO_DURATION;
                pomodoroTimerEl.textContent = formatTime(pomodoroTimeLeft);
                showMessage('info', 'Pomodoro reiniciado.');
            };

            // --- Navegação e Dicas ---
            const switchView = (view) => {
                const sections = { plan: planSection, tips: tipsSection, stats: statsSection, quickAddManage: quickAddManageSection };
                const buttons = { 
                    plan: [showPlanBtn, sidebar.querySelector('#sidebar-show-plan-btn')], 
                    tips: [showTipsBtn, sidebar.querySelector('#sidebar-show-tips-btn')], 
                    stats: [showStatsBtn, sidebar.querySelector('#sidebar-show-stats-btn')],
                    quickAddManage: [showQuickAddManageBtn, sidebar.querySelector('#sidebar-show-quick-add-manage-btn')]
                };

                Object.values(sections).forEach(section => section.classList.add('hidden'));
                Object.values(buttons).forEach(buttonArray => {
                    buttonArray.forEach(button => {
                        if (button) button.classList.replace('nav-btn-active', 'nav-btn-inactive');
                    });
                });
                
                sections[view].classList.remove('hidden');
                buttons[view].forEach(button => {
                    if (button) button.classList.replace('nav-btn-inactive', 'nav-btn-active');
                });

                if (view === 'stats') renderChart();
                if (view === 'quickAddManage') renderCustomQuickAddList(); // Re-render when this section is opened
                closeSidebar(); // Close sidebar after navigation
            };
            
            const handleAddTip = () => {
                const newTip = newTipInput.value.trim();
                if (newTip) {
                    tips.push(newTip);
                    newTipInput.value = '';
                    renderTips();
                    saveData();
                    showMessage('success', 'Dica adicionada!');
                }
            };

            const openSidebar = () => {
                sidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
            };

            const closeSidebar = () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            };

            // --- Gerenciamento de Templates ---
            const saveTemplate = () => {
                const templateName = templateNameInput.value.trim();
                if (!templateName) {
                    showMessage('error', 'Por favor, digite um nome para o template.');
                    return;
                }
                templates[templateName] = JSON.parse(JSON.stringify(activities)); // Deep copy activities
                saveData();
                renderTemplates();
                templateNameInput.value = '';
                showMessage('success', `Template "${templateName}" salvo com sucesso!`);
            };

            const loadTemplate = () => {
                const templateName = loadTemplateSelect.value;
                if (!templateName) {
                    showMessage('warning', 'Selecione um template para carregar.');
                    return;
                }
                showConfirmation(`Carregar o template "${templateName}" irá substituir o plano atual. Deseja continuar?`, (confirmed) => {
                    if (confirmed) {
                        activities = JSON.parse(JSON.stringify(templates[templateName])); // Deep copy
                        // Reset recorded times and alarms for loaded template
                        activities.forEach(activity => {
                            activity.recordedTime = 0;
                            activity.alarmTriggered = false;
                            activity.selected = false;
                        });
                        if (activeTimerInterval) pauseTimer();
                        render();
                        saveData();
                        showMessage('success', `Template "${templateName}" carregado com sucesso!`);
                    }
                    confirmationModal.classList.add('hidden');
                });
            };

            const renderTemplates = () => {
                loadTemplateSelect.innerHTML = '<option value="">Selecione um template</option>';
                for (const name in templates) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    loadTemplateSelect.appendChild(option);
                }
            };

            // --- Quick Add Buttons (Main Section) ---
            const renderQuickAddButtons = () => {
                quickAddButtonsContainer.innerHTML = '';
                // Render all quick activities as buttons in the main plan section
                allQuickActivities.forEach(qa => {
                    const button = document.createElement('button');
                    // Changed button class to distinguish from management view, using a common style here
                    button.className = 'px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400';
                    button.textContent = qa.description;
                    button.addEventListener('click', () => {
                        addActivityFromQuickAdd(qa);
                    });
                    quickAddButtonsContainer.appendChild(button);
                });
            };

            const addActivityFromQuickAdd = (qa) => {
                const lastActivity = activities[activities.length - 1];
                const newStartTime = lastActivity ? calculateEndTime(lastActivity.startTime, lastActivity.duration) : '09:00';
                activities.push({
                    id: Date.now() + Math.random(), // Ensure unique ID for quick add
                    startTime: newStartTime,
                    description: qa.description,
                    duration: qa.duration,
                    recordedTime: 0,
                    productivity: qa.productivity,
                    lever: qa.lever,
                    alarmTriggered: false,
                    selected: false
                });
                render();
                saveData();
                showMessage('success', `Atividade rápida "${qa.description}" adicionada.`);
            };

            // --- Populate Quick Add Dropdowns (Management Section) ---
            const populateQuickAddDropdowns = () => {
                const productivitySelect = document.getElementById('new-custom-quick-add-productivity');
                const leverSelect = document.getElementById('new-custom-quick-add-lever');

                // Clear existing options, keeping the default "Produtividade" and "Alavancador"
                productivitySelect.innerHTML = '<option value="">Produtividade</option>';
                leverSelect.innerHTML = '<option value="">Alavancador</option>';

                // Populate Productivity options
                for (const key in productivityLevels) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = productivityLevels[key];
                    productivitySelect.appendChild(option);
                }

                // Populate Lever options
                for (const key in levers) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = levers[key];
                    leverSelect.appendChild(option);
                }
            };


            const handleAddCustomQuickActivity = () => {
                const description = newCustomQuickAddDescription.value.trim();
                const durationInput = newCustomQuickAddDuration.value.trim();
                const productivity = newCustomQuickAddProductivity.value;
                const lever = newCustomQuickAddLever.value;

                if (!description || !durationInput || !productivity || !lever) {
                    showMessage('error', 'Por favor, preencha todos os campos para a nova atividade rápida.');
                    return;
                }

                let parsedDuration = 0;
                if (durationInput.includes(':')) {
                    const [hours, minutes] = durationInput.split(':').map(Number);
                    parsedDuration = hours * 60 + minutes;
                } else {
                    parsedDuration = parseInt(durationInput, 10);
                }

                if (isNaN(parsedDuration) || parsedDuration <= 0) {
                    showMessage('error', 'Por favor, insira uma duração válida (minutos ou HH:MM).');
                    return;
                }

                const newCustomQa = {
                    description,
                    duration: parsedDuration,
                    productivity,
                    lever
                };
                allQuickActivities.push(newCustomQa); // Add to the combined list
                saveData();
                renderQuickAddButtons(); // Re-render buttons for main view
                renderCustomQuickAddList(); // Update the list for management view
                // Clear input fields
                newCustomQuickAddDescription.value = '';
                newCustomQuickAddDuration.value = '';
                newCustomQuickAddProductivity.value = '';
                newCustomQuickAddLever.value = '';
                showMessage('success', `Atividade rápida personalizada "${description}" adicionada.`);
            };

            const renderCustomQuickAddList = () => {
                customQuickAddList.innerHTML = '';
                if (allQuickActivities.length === 0) {
                    customQuickAddList.innerHTML = '<p class="text-gray-600 text-sm">Nenhuma atividade rápida adicionada ainda.</p>';
                    return;
                }
                allQuickActivities.forEach((qa, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md shadow-sm text-gray-700';
                    div.innerHTML = `
                        <span>${qa.description} (${qa.duration}min) - ${productivityLevels[qa.productivity]} / ${levers[qa.lever]}</span>
                        <button data-index="${index}" class="remove-all-quick-add-btn text-red-500 hover:text-red-700 p-1" title="Remover Atividade Rápida">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    customQuickAddList.appendChild(div);
                });
            };

            const handleRemoveAllQuickAdd = (index) => {
                allQuickActivities.splice(index, 1);
                saveData();
                renderQuickAddButtons(); // Update buttons on main page
                renderCustomQuickAddList(); // Update list on management page
                showMessage('info', 'Atividade rápida removida.');
            };


            // --- Active Activity Modal Functions ---
            const openActiveActivityModal = (activity) => {
                modalActivityDescription.textContent = activity.description;
                modalActivityProductivity.textContent = productivityLevels[activity.productivity];
                modalActivityLever.textContent = levers[activity.lever];
                modalRecordedTimeHHMMSS.textContent = formatTime(activity.recordedTime);
                modalRecordedTimeFriendly.textContent = formatSecondsToFriendly(activity.recordedTime);
                modalPlannedTime.textContent = minutesToHHMM(activity.duration);

                // Apply productivity color to the modal content wrapper
                modalContentWrapper.classList.remove('productivity-green-card', 'productivity-yellow-card', 'productivity-red-card');
                if (activity.productivity === 'green') {
                    modalContentWrapper.classList.add('productivity-green-card');
                } else if (activity.productivity === 'yellow') {
                    modalContentWrapper.classList.add('productivity-yellow-card');
                } else if (activity.productivity === 'red') {
                    modalContentWrapper.classList.add('productivity-red-card');
                }

                // Attach modal buttons to the active activity
                modalPauseBtn.onclick = () => pauseTimer();
                modalResetBtn.onclick = () => resetTimer(activity.id);

                activeActivityModal.classList.remove('hidden');
                activeActivityModal.classList.add('flex');
            };

            const closeActiveActivityModal = () => {
                activeActivityModal.classList.add('hidden');
            };

            // --- Fixed Action Bar Logic ---
            const getSelectedActivities = () => activities.filter(act => act.selected);

            const updateFixedActionBarVisibility = () => {
                const selected = getSelectedActivities();
                if (selected.length > 0) {
                    fixedActionBar.classList.remove('hidden');
                } else {
                    fixedActionBar.classList.add('hidden');
                }
            };

            const handleFixedActionStart = () => {
                const selected = getSelectedActivities();
                if (selected.length !== 1) {
                    showMessage('warning', 'Selecione apenas UMA atividade para iniciar.');
                    return;
                }
                startTimer(selected[0].id);
                openActiveActivityModal(selected[0]);
            };

            const handleFixedActionPause = () => {
                pauseTimer();
            };

            const handleFixedActionDelete = () => {
                const selected = getSelectedActivities();
                if (selected.length === 0) {
                    showMessage('warning', 'Selecione atividades para excluir.');
                    return;
                }
                showConfirmation(`Tem certeza que deseja excluir ${selected.length} atividade(s)?`, (confirmed) => {
                    if (confirmed) {
                        activities = activities.filter(act => !act.selected);
                        if (selected.some(s => s.id === activeTimerId)) pauseTimer();
                        render();
                        saveData();
                        showMessage('success', `${selected.length} atividade(s) excluída(s).`);
                    }
                    confirmationModal.classList.add('hidden');
                });
            };

            const updateSelectAllCheckbox = () => {
                const allActivitiesSelected = activities.length > 0 && activities.every(act => act.selected);
                selectAllActivitiesCheckbox.checked = allActivitiesSelected;
            };

            // --- Drag and Drop ---
            let draggedItem = null;

            tableBody.addEventListener('dragstart', (e) => {
                // Ensure drag is only for the TR and not its children like inputs/buttons
                if (e.target.tagName === 'TR' || e.target.closest('tr')) {
                     const targetRow = e.target.closest('tr');
                     if (targetRow && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'TEXTAREA') {
                        draggedItem = targetRow;
                        e.dataTransfer.effectAllowed = 'move';
                        e.target.classList.add('dragging');
                     } else {
                        e.preventDefault(); // Prevent dragging for interactive elements
                     }
                }
            });

            tableBody.addEventListener('dragover', (e) => {
                e.preventDefault(); // Necessary to allow drop
                const targetRow = e.target.closest('tr');
                if (targetRow && draggedItem !== targetRow) {
                    const bounding = targetRow.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);
                    // Clear previous borders
                    Array.from(tableBody.children).forEach(row => {
                        row.style.borderTop = '';
                        row.style.borderBottom = '';
                    });
                    if (e.clientY - offset > 0) {
                        targetRow.style.borderBottom = '2px solid #3b82f6';
                    } else {
                        targetRow.style.borderTop = '2px solid #3b82f6';
                    }
                }
            });

            tableBody.addEventListener('dragleave', (e) => {
                const targetRow = e.target.closest('tr');
                if (targetRow) {
                    targetRow.style.borderTop = '';
                    targetRow.style.borderBottom = '';
                }
            });

            tableBody.addEventListener('drop', (e) => {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (targetRow && draggedItem && draggedItem !== targetRow) {
                    const draggedId = Number(draggedItem.dataset.id);
                    const targetId = Number(targetRow.dataset.id);

                    const draggedIndex = activities.findIndex(act => act.id === draggedId);
                    const targetIndex = activities.findIndex(act => act.id === targetId);

                    if (draggedIndex === -1 || targetIndex === -1) return;

                    const [removed] = activities.splice(draggedIndex, 1);
                    const insertBefore = e.clientY < targetRow.getBoundingClientRect().top + (targetRow.offsetHeight / 2);

                    activities.splice(insertBefore ? targetIndex : targetIndex + (draggedIndex < targetIndex ? 0 : 1), 0, removed);
                    
                    // Reset start times for consistency after reordering
                    recalculateActivityTimes(0);
                    render();
                    saveData();
                }
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    // Reset any temporary styling from dragover
                    const allRows = tableBody.querySelectorAll('tr');
                    allRows.forEach(row => {
                        row.style.borderTop = '';
                        row.style.borderBottom = '';
                    });
                }
                draggedItem = null;
            });

            tableBody.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    // Reset any temporary styling from dragover
                    const allRows = tableBody.querySelectorAll('tr');
                    allRows.forEach(row => {
                        row.style.borderTop = '';
                        row.style.borderBottom = '';
                    });
                }
                draggedItem = null;
            });

            // --- Gráfico ---
            const renderChart = () => {
                const ctx = document.getElementById('stats-chart').getContext('2d');
                if (chartInstance) {
                    chartInstance.destroy();
                }

                // Get all dates in historicalData and sort them
                const allDates = Object.keys(historicalData).sort();
                // We want to calculate the AVERAGE time spent on each lever over ALL available historical days.
                // Or total time? The prompt says "visão global do seu tempo total investido em cada "Alavancador" ao longo de todos os dias". So total.

                const totalLeverTimes = Object.keys(levers).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});

                allDates.forEach(date => {
                    Object.keys(levers).forEach(leverKey => {
                        if (historicalData[date] && historicalData[date][leverKey] !== undefined) {
                            totalLeverTimes[leverKey] += historicalData[date][leverKey];
                        }
                    });
                });

                const labels = Object.values(levers); // Labels for the radar chart axes
                const dataPoints = labels.map(leverName => {
                    const leverKey = Object.keys(levers).find(key => levers[key] === leverName);
                    return (totalLeverTimes[leverKey] || 0) / 3600; // Convert seconds to hours
                });

                chartInstance = new Chart(ctx, {
                    type: 'radar', // Changed to radar chart
                    data: { labels: labels, datasets: [{
                        label: 'Horas Totais Gastas',
                        data: dataPoints,
                        backgroundColor: 'rgba(96, 165, 250, 0.4)', // Blue with transparency
                        borderColor: 'rgba(96, 165, 250, 1)',
                        pointBackgroundColor: 'rgba(96, 165, 250, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(96, 165, 250, 1)'
                    }] },
                    options: {
                        responsive: true,
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    display: false
                                },
                                suggestedMin: 0, // Start from 0 hours
                                ticks: {
                                    beginAtZero: true,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true // Keep legend to show 'Horas Totais Gastas'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.r.toFixed(2) + ' horas'; // Display hours
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // --- Utilitários ---
            const timeToMinutes = (timeStr) => { 
                const [h, m] = timeStr.split(':').map(Number); 
                return h * 60 + m; 
            };
            const calculateDurationInMinutes = (start, end) => timeToMinutes(end) - timeToMinutes(start);
            const formatTime = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };
            const minutesToHHMM = (totalMinutes) => {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
            };
            const calculateEndTime = (start, dur) => { 
                const t = timeToMinutes(start) + dur; 
                const totalMinutesInDay = 24 * 60;
                const adjustedT = t % totalMinutesInDay; // Handle overflow to next day if duration goes beyond midnight
                const hours = Math.floor(adjustedT / 60);
                const minutes = adjustedT % 60;
                return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
            };
            const formatSecondsToFriendly = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                let parts = [];
                if (hours > 0) parts.push(`${hours} hora${hours > 1 ? 's' : ''}`);
                if (minutes > 0) parts.push(`${minutes} minuto${minutes > 1 ? 's' : ''}`);
                if (seconds > 0) parts.push(`${seconds} segundo${seconds > 1 ? 's' : ''}`);

                if (parts.length === 0) return '0 segundos';
                if (parts.length === 1) return parts[0];
                return parts.slice(0, -1).join(', ') + ' e ' + parts[parts.length - 1];
            };
            
            const handleSavePdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.text("Meu Plano de Produtividade", 14, 15);
                doc.setFontSize(10);
                doc.text(currentDateEl.textContent, 14, 22);

                const head = [['Checkbox', 'Arrastar', 'Horário', 'Atividade', 'Duração (min/HH:MM)', 'Registrado', 'Produtividade', 'Alavancador']];
                const body = activities.map(act => [
                    act.selected ? 'X' : '', // Checkbox
                    '⋮', // Drag handle visual in PDF
                    `${act.startTime} - ${calculateEndTime(act.startTime, act.duration)}`,
                    act.description,
                    `${act.duration} min (${minutesToHHMM(act.duration)})`,
                    formatTime(act.recordedTime),
                    productivityLevels[act.productivity],
                    levers[act.lever]
                ]);
                doc.autoTable({ head, body, startY: 28, styles: { font: 'Inter', fontSize: 8 }, headStyles: { fillColor: '#4a5568' }, theme: 'grid' });
                doc.save('plano-produtividade.pdf');
                showMessage('success', 'Plano exportado para PDF!');
            };

            // --- Relógio Atual no Rodapé ---
            const updateCurrentTimeDisplay = () => {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                currentTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            };
            setInterval(updateCurrentTimeDisplay, 1000); // Update every second

            // --- LLM Integration: Generate Smart Summary ---
            const generateSmartSummary = async () => {
                smartSummaryContent.innerHTML = '<p class="text-center text-gray-500 italic">A gerar o seu resumo...</p>';
                smartSummaryLoading.classList.remove('hidden');
                smartSummaryModal.classList.remove('hidden');
                smartSummaryModal.classList.add('flex');

                if (activities.length === 0) {
                    smartSummaryContent.innerHTML = '<p class="text-center text-gray-600">Nenhuma atividade registada para gerar um resumo. Adicione algumas atividades primeiro!</p>';
                    smartSummaryLoading.classList.add('hidden');
                    return;
                }

                let prompt = `Você é um assistente de produtividade. Dada uma lista de atividades diárias, seu objetivo é fornecer um resumo perspicaz e inspirador do dia. Analise os dados e destaque os pontos fortes, áreas de melhoria e ofereça conselhos acionáveis ou uma mensagem motivacional.

Formato das atividades:
- Descrição: [string]
- Duração Planeada: [minutos]
- Tempo Registrado: [segundos]
- Produtividade: [Verde/Amarelo/Vermelho]
- Alavancador: [Saúde e Bem-Estar/Desenvolvimento Profissional/Desenvolvimento Pessoal/Relacionamentos/Finanças/Outros]

Aqui estão as atividades do dia:
`;

                activities.forEach(activity => {
                    const recordedMinutes = Math.floor(activity.recordedTime / 60);
                    prompt += `- Descrição: ${activity.description}, Duração Planeada: ${activity.duration} minutos, Tempo Registrado: ${recordedMinutes} minutos, Produtividade: ${productivityLevels[activity.productivity]}, Alavancador: ${levers[activity.lever]}\n`;
                });

                prompt += `\nPor favor, forneça um resumo detalhado e motivacional sobre o dia, incluindo análises sobre tempo planeado vs. tempo registado, e sugestões para otimização ou celebração de conquistas. Use a linguagem portuguesa (Portugal). Responda com parágrafos separados por duas quebras de linha.`;

                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = ""; // Canvas will provide this in runtime
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const summaryText = result.candidates[0].content.parts[0].text;
                        // Replace double newlines with <p> tags for better paragraph separation
                        const formattedText = summaryText.split('\n\n').map(paragraph => `<p>${paragraph.replace(/\n/g, '<br>')}</p>`).join('');
                        smartSummaryContent.innerHTML = formattedText;
                    } else {
                        smartSummaryContent.innerHTML = '<p class="text-red-600">Erro: Não foi possível gerar o resumo. Tente novamente.</p>';
                        console.error('Gemini API returned an unexpected structure:', result);
                    }
                } catch (error) {
                    smartSummaryContent.innerHTML = '<p class="text-red-600">Erro na comunicação com a Gemini API. Verifique a sua ligação ou tente mais tarde.</p>';
                    console.error('Error calling Gemini API:', error);
                } finally {
                    smartSummaryLoading.classList.add('hidden');
                }
            };

            const copySmartSummaryToClipboard = () => {
                const summaryText = smartSummaryContent.innerText;
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = summaryText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                showMessage('success', 'Resumo copiado para a área de transferência!');
            };


            // --- Listeners de Eventos ---
            // Sidebar controls
            openSidebarBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar); // Close sidebar when clicking overlay

            addActivityColumnBtn.addEventListener('click', handleAddActivity); // Novo listener para o botão na coluna

            savePdfBtn.addEventListener('click', handleSavePdf);
            exportCsvBtn.addEventListener('click', handleCsvExport);
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleCsvImport);
            copyCsvBtn.addEventListener('click', handleCopyCsv);
            saveDailySummaryBtn.addEventListener('click', handleSaveDailySummary);

            // Template management
            saveTemplateBtn.addEventListener('click', saveTemplate);
            loadTemplateBtn.addEventListener('click', loadTemplate);

            tableBody.addEventListener('click', handleTableClick);
            tableBody.addEventListener('change', handleTableChange); // For input/select/textarea changes

            selectAllActivitiesCheckbox.addEventListener('change', (e) => {
                activities.forEach(activity => activity.selected = e.target.checked);
                render(); // Re-render to update checkboxes
                updateFixedActionBarVisibility();
                saveData();
            });

            // Navigation
            sidebar.querySelector('#sidebar-show-plan-btn').addEventListener('click', () => switchView('plan'));
            sidebar.querySelector('#sidebar-show-tips-btn').addEventListener('click', () => switchView('tips'));
            sidebar.querySelector('#sidebar-show-stats-btn').addEventListener('click', () => switchView('stats'));
            sidebar.querySelector('#sidebar-show-quick-add-manage-btn').addEventListener('click', () => switchView('quickAddManage')); // New listener for Quick Add Management
            
            addTipBtn.addEventListener('click', handleAddTip);
            tipsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-tip-btn')) {
                    tips.splice(parseInt(e.target.dataset.index, 10), 1);
                    renderTips();
                    saveData();
                    showMessage('info', 'Dica removida.');
                }
            });
            newTipInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddTip(); });
            closeAlarmBtn.addEventListener('click', () => alarmModal.classList.add('hidden'));

            // Active Activity Modal listeners
            closeActiveActivityModalBtn.addEventListener('click', closeActiveActivityModal);
            // Modal pause/reset are still relevant for the currently active task
            modalPauseBtn.addEventListener('click', pauseTimer);
            modalResetBtn.addEventListener('click', () => {
                if (activeTimerId) resetTimer(activeTimerId);
            });

            // Pomodoro listeners
            pomodoroStartBtn.addEventListener('click', startPomodoro);
            pomodoroPauseBtn.addEventListener('click', pausePomodoro);
            pomodoroResetBtn.addEventListener('click', resetPomodoro);

            // Confirmation Modal listeners
            confirmYesBtn.addEventListener('click', () => {
                if (confirmationCallback) confirmationCallback(true);
                confirmationModal.classList.add('hidden');
            });
            confirmNoBtn.addEventListener('click', () => {
                if (confirmationCallback) confirmationCallback(false);
                confirmationModal.classList.add('hidden');
            });

            // Fixed Action Bar listeners
            actionStartBtn.addEventListener('click', handleFixedActionStart);
            actionPauseBtn.addEventListener('click', handleFixedActionPause);
            actionDeleteBtn.addEventListener('click', handleFixedActionDelete);

            // Quick Add Management Listeners
            addCustomQuickActivityBtn.addEventListener('click', handleAddCustomQuickActivity);
            customQuickAddList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-all-quick-add-btn')) { // Changed class name
                    const index = parseInt(e.target.dataset.index, 10);
                    handleRemoveAllQuickAdd(index); // Changed function name
                }
            });


            // LLM Feature Listeners
            generateSummaryBtn.addEventListener('click', generateSmartSummary);
            closeSmartSummaryModalBtn.addEventListener('click', () => smartSummaryModal.classList.add('hidden'));
            copySummaryBtn.addEventListener('click', copySmartSummaryToClipboard);
            
            // --- Inicialização ---
            loadData();
        });
    </script>
</body>
</html>
